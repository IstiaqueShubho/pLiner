# pLiner

**pLiner** is a framework that helps programmers identify locations in the source of numerical code that are highly affected by compiler optimizations.  


# Getting Started

## Requirements to use pLiner
- pLiner is implemented as a clang tool. Installing clang/LLVM compiler is a prerequisite to use pLiner. So far, we have tested pLiner on clang/LLVM 9.0.0.
- So far pLiner only supports C/C++.

## Building
  1. obtain and build clang/LLVM:  
    https://clang.llvm.org/docs/LibASTMatchersTutorial.html  
  2. clone the repo. and put pLiner source inside clang-tools-extra  
    `$ cd clang-tools-extra`  
    `$ cp -r $PATH-TO-pLiner pLiner`  
  3. add pLiner to clang tool CMakeLists.txt  
    `$ echo "add_subdirectory(pLiner/clang-tool)" >> ../../clang-tools-extra/CmakeLists.txt`  
  4. build clang tool  
    `$ cd $PATH-TO-CLANG-BUILD`  
    `$ ninja`  

## Using pLiner

### Example

We use a simple C program to show how to use pLiner.   

The C program `vtest.c` produces inconsistent result when compiled with `gcc -O3 -ffast-math` compared to `gcc -O0`. pLiner isolated a line of the code in the source (Line 25) as the origin of the compiler-induced inconsistency. pLiner also provided a transformated version of the program `vtest_trans.c` in which the isolated line of the code has been transformed to higher precision, and the transformed program `vtest_trans.c` produces consistent results between `gcc -O3 -ffast-math` and `gcc -O0`.

  1. go to `example` directory  
    `$ cd pLiner/example`  
  2. compile `vtest.c` with both `gcc -O3 -ffast-math` and `gcc -O0`, and compare the results  
    `make`  
    `vtest_O0` corresponds to the executable generated by compiling `vtest.c` with `gcc -O0`, and `vtest_O3` corresponds to the executable generated by compiling `vtest.c` with `gcc -O3 -ffast-math`.  
    `./cmp.sh vtest`  
    `vtest_O0` produces `1.7071999999999999e+208` when executed with the given input data while `vtest_O3` produces `-1.8508999968058596e-316`; the difference is very large.  
  3. run pLiner  
    `python pLiner/scripts/search.py vtest.c "--"`   
    The first argument `vtest.c` is the input program; the second argument `"--"` indicates that to compile the input program there are no header files/librares to specify in the compilation command. Additionally, if there are any such compilation options such as "-I $PATH-TO-HEADERS", specify them following "--" in the second argument, e.g., "-- -I $PATH-TO-HEADERS". 

   * pLiner found the root cause of the inconsistency (function `compute`, line 25):  
    ` compute :`  
    `    line 25`    

   * pLiner generated a transformed program `vtest_trans.c`:  
     compile `vtest_trans.c` with both `gcc -O3 -ffast-math` and `gcc -O0`, and compare the results  
     `make`  
     `./cmp.sh vtest_trans`  
     Both `vtest_trans_O0` and `vtest_trans_O3` produce `1.7071999999999999e+208`. The results are consistent with `vtest_O0`.  
### Use pLiner for your programs

You can follow the instructions as shown in the example to run pLiner for your own programs. Specifically, 

* Specify the compiler, compilation options that induce inconsistent results, and an error threshold in `run.sh`  
 In the example above, those are specified in `run.sh` as
 ```
 CC="/usr/bin/gcc"
 CFLAGS=" -O0 -g -std=c99"
 CFLAGS_trouble=" -O3 -ffast-math -g -std=c99"
 THRESHOLD=8 
 ```
 `CC` specifies the compiler; `CFLAGS` specifies the compilation options that are used to produce ground-truth results and `CFLAGS_trouble` specifies the compilation options that induce inconsistent results; lastly, `THRESHOLD` specifies the number of digits that are required to be same with the ground truth for consistency check.
 
* Specify your program file in the first argument, and the compilation options needed to compile the program in the second argument such as 
`python pLiner/scripts/search.py vtest.c "--"` in the example.
